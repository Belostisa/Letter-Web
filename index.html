<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Encrypted Letter</title>
  <link rel="stylesheet" href="style.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>

  <!-- FULL BACKGROUND VIDEO -->
  <div class="bg-video">
    <video autoplay muted loop playsinline>
      <source src="media/bg.mp4" type="video/mp4">
    </video>
  </div>

  <!-- AUDIO -->
  <audio id="bgAudio" loop preload="auto" crossorigin="anonymous">
    <source src="media/sextape.mp3" type="audio/mpeg">
  </audio>

  <!-- FLOWERS -->
  <section class="flowers-section">
    <video autoplay muted loop playsinline class="flowers-video">
      <source src="media/flowers2.mp4" type="video/mp4">
    </video>
  </section>

  <!-- WAVE OVERLAY -->
  <div class="wave-overlay" id="waveOverlay" aria-hidden="true">
    <canvas id="waveCanvas"></canvas>
  </div>

  <!-- SINGLE PLAY BUTTON -->
  <button class="wave-play" id="playWave" aria-label="Play">▶</button>

  <!-- ENVELOPE -->
  <section class="envelope-section">
    <div class="envelope" onclick="openEmail()">
      <div class="envelope-back"></div>
      <div class="inbox-label">INBOX</div>
      <div class="envelope-flap"></div>
    </div>
  </section>

  <!-- EMAIL WINDOW -->
  <div class="email-overlay" id="emailOverlay">
    <div class="email-window">
      <div class="email-header">
        <span class="email-title">Inbox</span>
        <button class="email-close" onclick="closeEmail()">✕</button>
      </div>

      <div class="email-body" id="emailContent"></div>

      <div class="email-footer">
        <button onclick="prevPage()">◀ Prev</button>
        <span id="pageIndicator">1 / 3</span>
        <button onclick="nextPage()">Next ▶</button>
      </div>
    </div>
  </div>

<script>
/* =========================
   EMAIL PAGES (unchanged)
========================= */
const pages = [
`Hkls, q dYtZp FhEw yCjO uXnRzS PkLwO hAqMZ. RvTnO YZ qBHeF, kLZpVq, jF hLk OqTjM, fP XnO kLqF uPzM. HZJ nRkY, FhEw HZJ kPqRjTQ iLwPpU nXqZ TqJ FhEw HZJ YkLZQ pJwO hFZ uLkY, kLZpU yF TqJ, fP XnO hAqMZ.

VZJ pFZQ pJwO ZkLwZV hFZ pJZ. Y nOZ kFZ YZpFZL FhZQ, kLZQ HZJ nFZ pRkYpJYh, ZLZpZrZP FhZQ QJpFZ. Y RkZ ZL, FhZQ Y TqJ Y pFZqRZ FhZQ Y pJZL. ZPZ FhZQ pJwO hZJZL YZ uPZpQZ, FhZQ ZkLZQJ pJZ pJZL uFZQ pJZL Y nOZ YZ.

RvTnO, FhZQ ZLZLZP FhZQ pJZ QJwFZ, nOZkZ YZ pJZLZ. Y QZLZ, FhZQ YZ OqFZ pFZpZLZ FhZQ QZLZLZ, nOZkZ QZLZLZ. TqJ, qJZ pZLZLZ FhZQ pFZLZ pJZL, ZPZ nOZ ZPZLZ ZkLZQZ QZLZ. HZ pZLZLZ Y nOZ pJZL.`,
`Y nOZLZ, pZLZQ pZLZLZ pJZLZ pFZQ. nOZkZ, ZkZ pFZLZ pZLZLZ, pZLZLZ ZLZLZ ZPZ. Y pFZLZ FhZQ pZLZQ ZkZLZLZ, Y pFZLZ nOZ ZLZ. Np Y pFZLZ nOZ ZkLZ pZLZLZ, FhZQ ZPZ nOZpZLZ, pFZLZ nOZ pJZLZ.

Y nOZLZLZ, FhZQ ZkZLZLZ pZLZ pJZLZ, nOZ ZLZLZ pFZLZ pZLZLZ, Y ZLZLZ ZPZ ZLZLZ ZPZ. FhZQ kZpZLZ pZLZLZ pFZLZ pZLZLZ nOZ ZkZLZ pZLZLZ pFZLZ pZLZLZ. V nOZLZLZ kZ pZLZ. Y pZLZLZ ZkZLZLZ ZPZ ZPZLZLZ. ZPZ pZLZLZ pZLZLZ ZPZ, Y pFZLZ pZLZ.`,
`RZLZLZ, nOZ pZLZLZ pJZLZ ZkZLZLZ pZLZLZ. Y nOZLZLZ Y nOZ ZPZ ZPZ nOZ pZLZLZ FhZQ pZLZLZ. FhZQ ZPZ pZLZLZ nOZ ZPZ, FhZQ ZPZ pZLZLZ. ZPZ pZLZLZ pZLZLZ pZLZLZ Y ZkZLZLZ, Y ZPZ pZLZLZ ZPZ ZPZ pZLZLZ.

Y pFZLZ pZLZLZ, FhZQ pZLZLZ pZLZLZ ZkZLZLZ ZPZ pZLZLZ ZPZ pZLZLZ. FhZQ ZkZLZLZ ZPZ pZLZLZ Y pZLZLZ pZLZLZ. ZPZ ZkLZLZ Y ZkZLZLZ, ZPZ Y pFZLZ nOZ pZLZLZ.

Y pZLZLZ pZLZLZ FhZQ pZLZLZ, nOZ Y pZLZLZ ZkZLZLZ, FhZQ ZkZLZLZ pZLZLZ ZkZLZLZ Y pZLZLZ pZLZLZ ZPZ. nOZLZLZ, kZLZLZ ZkZLZLZ ZPZLZLZ nOZ pZLZLZ, Y pZLZLZ ZkZLZLZ Y pZLZLZ.`
];

let currentPage = 0;

function openEmail(){
  document.querySelector(".envelope").classList.add("open");
  document.getElementById("emailOverlay").style.display = "flex";
  renderPage();
}
function closeEmail(){
  document.querySelector(".envelope").classList.remove("open");
  document.getElementById("emailOverlay").style.display = "none";
}
function renderPage(){
  document.getElementById("emailContent").textContent = pages[currentPage];
  document.getElementById("pageIndicator").textContent = `${currentPage + 1} / ${pages.length}`;
}
function nextPage(){
  if (currentPage < pages.length - 1){ currentPage++; renderPage(); }
}
function prevPage(){
  if (currentPage > 0){ currentPage--; renderPage(); }
}

/* =========================
   WAVES + ROMANTIC INTERACTIONS
   - Envelope glow reacts subtly to audio
   - Play button dissolves into wave particles
   - Clicking flowers spawns pink particles (works even if flowers have pointer-events: none)
========================= */
const playBtn = document.getElementById("playWave");
const audioEl = document.getElementById("bgAudio");
const overlay = document.getElementById("waveOverlay");
const canvas  = document.getElementById("waveCanvas");
const ctx     = canvas.getContext("2d", { alpha: true });

const flowersEl  = document.querySelector(".flowers-video") || document.querySelector(".flowers-section");
const envelopeEl = document.querySelector(".envelope");
const envelopeBack = document.querySelector(".envelope-back") || envelopeEl;

let audioCtx = null;
let analyser = null;
let srcNode  = null;
let timeData = null;
let freqData = null;

let started = false;
let rafId = 0;
let posRaf = 0;

const clamp = (v, a, b) => Math.min(b, Math.max(a, v));
const lerp  = (a, b, t) => a + (b - a) * t;

/* desktop-only thickness multiplier */
function waveThickness(){
  return window.matchMedia("(max-width: 600px)").matches ? 1.0 : 1.25;
}

/* --- canvas sizing (crisp) --- */
function resizeCanvas(){
  const rect = canvas.getBoundingClientRect();
  const dpr = Math.max(1, window.devicePixelRatio || 1);

  const w = Math.max(1, Math.floor(rect.width  * dpr));
  const h = Math.max(1, Math.floor(rect.height * dpr));

  if (canvas.width !== w || canvas.height !== h){
    canvas.width = w;
    canvas.height = h;
  }
  // draw in CSS pixels (we scale the context)
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
}

/* --- stable placement: between flower video bottom and envelope top --- */
function updateWavePosition(){
  if (!flowersEl || !envelopeEl) return;

  const f = flowersEl.getBoundingClientRect();
  const e = envelopeEl.getBoundingClientRect();

  let y = (f.bottom + e.top) / 2;

  // subtle lift (romantic composition)
  const lift = Math.min(32, window.innerHeight * 0.04);
  y -= lift;

  const pad = Math.max(48, Math.min(96, window.innerHeight * 0.08));
  y = clamp(y, pad, window.innerHeight - pad);

  document.documentElement.style.setProperty("--wave-y", `${y}px`);
}

function scheduleLayoutUpdate(){
  if (posRaf) return;
  posRaf = requestAnimationFrame(() => {
    posRaf = 0;
    updateWavePosition();
    resizeCanvas();
  });
}

window.addEventListener("resize", scheduleLayoutUpdate, { passive: true });
window.addEventListener("scroll", scheduleLayoutUpdate, { passive: true });

if (window.visualViewport){
  visualViewport.addEventListener("resize", scheduleLayoutUpdate, { passive: true });
  visualViewport.addEventListener("scroll", scheduleLayoutUpdate, { passive: true });
}

const ro = new ResizeObserver(() => scheduleLayoutUpdate());
if (flowersEl) ro.observe(flowersEl);
if (envelopeEl) ro.observe(envelopeEl);

scheduleLayoutUpdate();
setTimeout(scheduleLayoutUpdate, 150);
setTimeout(scheduleLayoutUpdate, 650);

/* --- audio analyser --- */
function setupAnalyser(){
  if (audioCtx) return;

  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 2048;
  analyser.smoothingTimeConstant = 0.82;

  timeData = new Uint8Array(analyser.frequencyBinCount);
  freqData = new Uint8Array(analyser.frequencyBinCount);

  srcNode = audioCtx.createMediaElementSource(audioEl);
  srcNode.connect(analyser);
  analyser.connect(audioCtx.destination);
}

/* --- audio read + smoothing --- */
let rmsSmooth = 0;
let trebleSmooth = 0;

function readAudio(){
  analyser.getByteTimeDomainData(timeData);
  analyser.getByteFrequencyData(freqData);

  // RMS loudness
  let sum = 0;
  for (let i = 0; i < timeData.length; i++){
    const v = (timeData[i] - 128) / 128;
    sum += v * v;
  }
  const rms = Math.sqrt(sum / timeData.length);
  rmsSmooth = lerp(rmsSmooth, rms, 0.09);

  // Treble energy
  let hi = 0;
  const start = Math.floor(freqData.length * 0.35);
  for (let i = start; i < freqData.length; i++) hi += freqData[i];
  const hiNorm = hi / ((freqData.length - start) * 255);
  trebleSmooth = lerp(trebleSmooth, clamp(hiNorm, 0, 1), 0.12);

  return { level: rmsSmooth, treble: trebleSmooth };
}

/* --- wave stroke (icy cyan) --- */
function strokeNeonBlue(drawPath, thickness = 1, glow = 1){
  ctx.save();
  ctx.globalCompositeOperation = "lighter";
  ctx.lineCap = "round";

  // outer haze
  ctx.shadowColor = "rgba(90,245,255,0.08)";
  ctx.shadowBlur  = 11 * glow;
  ctx.lineWidth   = 3.4 * thickness;
  ctx.strokeStyle = "rgba(90,245,255,0.07)";
  drawPath(); ctx.stroke();

  // mid glow
  ctx.shadowColor = "rgba(90,245,255,0.20)";
  ctx.shadowBlur  = 6.5 * glow;
  ctx.lineWidth   = 2.1 * thickness;
  ctx.strokeStyle = "rgba(90,245,255,0.18)";
  drawPath(); ctx.stroke();

  // core line
  ctx.shadowBlur  = 0;
  ctx.lineWidth   = 1.05 * thickness;
  ctx.strokeStyle = "rgba(120,255,255,0.82)";
  drawPath(); ctx.stroke();

  ctx.restore();
}

function envelopeShape(u){
  return Math.pow(Math.sin(Math.PI * u), 1.45);
}

/* --- lightweight motion noise --- */
function fbm(u, t, s = 1){
  return (
    Math.sin((u * 10.0 * s) + t * 1.3) * 0.55 +
    Math.sin((u * 23.0 * s) - t * 2.2) * 0.28 +
    Math.sin((u * 52.0 * s) + t * 3.7) * 0.17
  );
}

function travelingPulse(u, t, speed = 0.18, width = 0.06){
  const p = (t * speed) % 1;
  const d = Math.min(Math.abs(u - p), 1 - Math.abs(u - p));
  return Math.exp(-(d * d) / (width * width));
}

/* =========================
   Romantic particles
========================= */
const particles = [];

function spawnFlowerParticles(cx, cy){
  for (let i = 0; i < 18; i++){
    particles.push({
      x: cx,
      y: cy,
      vx: (Math.random() - 0.5) * 0.55,
      vy: -Math.random() * 0.85,
      life: 1,
      size: 2.5 + Math.random() * 4.5,
      type: "pink"
    });
  }
}

function spawnWaveParticles(cx, cy){
  for (let i = 0; i < 14; i++){
    particles.push({
      x: cx,
      y: cy,
      vx: (Math.random() - 0.5) * 1.2,
      vy: (Math.random() - 0.5) * 1.2,
      life: 1,
      size: 2 + Math.random() * 3,
      type: "cyan"
    });
  }
}

function drawParticles(){
  for (let i = particles.length - 1; i >= 0; i--){
    const p = particles[i];

    // motion (gentle drift)
    p.x += p.vx;
    p.y += p.vy;

    // soft slow-down
    p.vx *= 0.992;
    p.vy *= 0.992;

    // fade
    p.life -= 0.014;

    if (p.life <= 0){
      particles.splice(i, 1);
      continue;
    }

    ctx.save();
    ctx.globalCompositeOperation = "lighter";
    ctx.globalAlpha = p.life;

    if (p.type === "cyan"){
      ctx.fillStyle = "rgba(120,255,255,0.70)";
      ctx.shadowColor = "rgba(120,255,255,0.35)";
      ctx.shadowBlur = 10;
    } else {
      ctx.fillStyle = "rgba(255,140,210,0.70)";
      ctx.shadowColor = "rgba(255,140,210,0.35)";
      ctx.shadowBlur = 14;
    }

    ctx.beginPath();
    ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
    ctx.fill();
    ctx.restore();
  }
}

/* Convert viewport coords -> canvas (CSS pixel) coords */
function viewportToCanvasXY(vx, vy){
  const rect = canvas.getBoundingClientRect();
  return { x: vx - rect.left, y: vy - rect.top };
}

/* =========================
   Envelope glow reacts to audio
========================= */
function updateEnvelopeGlow(level){
  if (!envelopeBack) return;

  const a = 0.18 + level * 0.55;
  const b1 = 6 + level * 16;
  const b2 = 16 + level * 30;

  envelopeBack.style.boxShadow = `
    0 0 ${b1}px rgba(0,255,136,${a}),
    0 0 ${b2}px rgba(0,255,136,${a * 0.45})
  `;
}

/* =========================
   Flower click (works even if flowers have pointer-events:none)
========================= */
let lastFlowerClick = 0;
document.addEventListener("click", (e) => {
  if (!flowersEl) return;

  // ignore clicks on envelope/email UI
  if (e.target.closest(".envelope") || e.target.closest(".email-overlay")) return;

  const f = flowersEl.getBoundingClientRect();
  const inside = (e.clientX >= f.left && e.clientX <= f.right && e.clientY >= f.top && e.clientY <= f.bottom);
  if (!inside) return;

  const now = Date.now();
  if (now - lastFlowerClick < 220) return; // prevent spam
  lastFlowerClick = now;

  const { x, y } = viewportToCanvasXY(e.clientX, e.clientY);
  spawnFlowerParticles(x, y);
}, { passive: true });

/* =========================
   Play button dissolve
========================= */
function dissolvePlayButton(){
  const r = playBtn.getBoundingClientRect();
  const cx = r.left + r.width / 2;
  const cy = r.top + r.height / 2;
  const { x, y } = viewportToCanvasXY(cx, cy);
  spawnWaveParticles(x, y);
  playBtn.classList.add("hidden");
}

/* =========================
   Waves loop (lens style)
========================= */
function startLoop(){
  if (rafId) return;

  const loop = (now) => {
    rafId = requestAnimationFrame(loop);
    if (!started) return;

    const w = canvas.clientWidth;
    const h = canvas.clientHeight;

    ctx.clearRect(0, 0, w, h);

    const { level, treble } = readAudio();
    const t = now / 1000;

    // envelope reacts to audio (romantic breathing)
    updateEnvelopeGlow(level);

    const thickMul = waveThickness();

    const baseAmp = 6;
    const maxAmp  = 90;
    const ampPx   = baseAmp + maxAmp * Math.pow(level, 0.80);

    const electric = 0.35 + 0.95 * treble;

    const centerY = h * 0.5;
    const points = Math.max(240, Math.floor(w / 3));
    const dx = w / (points - 1);

    // subtle center bar
    ctx.save();
    ctx.globalCompositeOperation = "lighter";
    ctx.globalAlpha = 0.07 + 0.22 * level;
    ctx.fillStyle = "rgba(90,245,255,0.16)";
    ctx.fillRect(0, centerY - 1, w, 2);
    ctx.restore();

    // coherent displacement array
    const disp = new Array(points);
    for (let i = 0; i < points; i++){
      const u = i / (points - 1);

      const idx = Math.floor(u * (timeData.length - 1));
      const a = (timeData[idx] - 128) / 128;

      const pulse1 = travelingPulse(u, t, 0.20, 0.055);
      const pulse2 = travelingPulse(u, t + 2.1, 0.14, 0.08);

      const wobble = fbm(u, t * electric, 1.0) * 0.55;
      const micro  = Math.sin(t * (12.0 * electric) + u * (140 * electric)) * 0.12;

      const env = envelopeShape(u);

      disp[i] =
        env * (
          ampPx * (a * (0.62 + 0.55 * level)) +
          (18 + 38 * level) * wobble +
          (10 + 30 * treble) * micro +
          (55 * pulse1 * (0.20 + level)) +
          (32 * pulse2 * (0.15 + level * 0.8))
        );
    }

    function lensPair(phase, alpha, thickness, glow){
      ctx.save();
      ctx.globalAlpha = alpha;

      const phaseWarp = (u) =>
        Math.sin(u * 14 + t * (1.1 + phase)) * (1.5 + 3.0 * treble);

      const upperPath = () => {
        ctx.beginPath();
        for (let i = 0; i < points; i++){
          const u = i / (points - 1);
          const x = i * dx;
          const y = centerY - (disp[i] + phaseWarp(u));
          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        }
      };

      const lowerPath = () => {
        ctx.beginPath();
        for (let i = 0; i < points; i++){
          const u = i / (points - 1);
          const x = i * dx;
          const y = centerY + (disp[i] - phaseWarp(u) * 0.6);
          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        }
      };

      strokeNeonBlue(upperPath, thickness * thickMul, glow);
      strokeNeonBlue(lowerPath, thickness * thickMul, glow);

      ctx.restore();
    }

    const glowBoost = 0.72 + 0.85 * level + 0.55 * treble;

    lensPair(0.0, 0.90, 1.08, glowBoost);
    lensPair(1.1, 0.55, 0.95, glowBoost * 0.85);
    lensPair(2.2, 0.35, 0.82, glowBoost * 0.75);

    // spark motes (subtle)
    ctx.save();
    ctx.globalCompositeOperation = "lighter";
    ctx.globalAlpha = 0.05 + 0.14 * treble;
    ctx.fillStyle = "rgba(120,255,255,0.50)";
    for (let k = 0; k < 4; k++){
      const u = ((t * (0.12 + 0.04 * k)) + k * 0.19) % 1;
      const x = u * w;
      const r = 0.8 + 4.5 * treble;
      ctx.beginPath();
      ctx.arc(x, centerY, r, 0, Math.PI * 2);
      ctx.fill();
    }
    ctx.restore();

    // particles render on top (romantic clicks + dissolve)
    drawParticles();
  };

  rafId = requestAnimationFrame(loop);
}

/* =========================
   Play click
========================= */
playBtn.addEventListener("click", async (e) => {
  e.preventDefault();
  e.stopPropagation();

  setupAnalyser();
  if (audioCtx.state === "suspended") await audioCtx.resume();

  audioEl.muted = false;
  audioEl.volume = 0.35;

  if (audioEl.paused) await audioEl.play();

  started = true;
  overlay.classList.add("active");

  // dissolve into the wave space
  dissolvePlayButton();

  scheduleLayoutUpdate();
  startLoop();
});

</script>

</body>
</html>












